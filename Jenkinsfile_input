
def QUERY_RESULTS = [
    ["ENV": "DEV", "IMAGE": "jdk8-slim", "VERSION": "1.0"],
    ["ENV": "DEV", "IMAGE": "alpine", "VERSION": "1.2"],
    ["ENV": "DEV", "IMAGE": "buster", "VERSION": "1.6.2"]
]

def imageChoices = QUERY_RESULTS.collect { it.IMAGE }
def versionChoices = QUERY_RESULTS.collect { it.VERSION }

pipeline {
    agent any

    parameters {
        choice(
            choices: imageChoices,
            description: 'Select an image:',
            name: 'SELECTED_IMAGE'
        )
        
        choice(
            choices: [],
            description: 'Select a version:',
            name: 'SELECTED_VERSION'
        )
    }

    stages {
        stage('Set Version Choices') {
            steps {
                script {
                    def selectedImage = params.SELECTED_IMAGE
                    def versionChoices = QUERY_RESULTS.findAll { it.IMAGE == selectedImage }.collect { it.VERSION }
                    
                    currentBuild.rawBuild.getAction(hudson.model.ParametersAction).parameters.find { it.name == 'SELECTED_VERSION' }.choices = versionChoices.join('\n')
                }
            }
        }

        stage('Parameters') {
            steps {
                script {
                    def selectedImage = params.SELECTED_IMAGE
                    def selectedVersion = params.SELECTED_VERSION
                    
                    echo "Selected Image: ${selectedImage}"
                    echo "Selected Version: ${selectedVersion}"
                }
            }
        }
        
        // Add more stages as needed for your pipeline
    }
}
